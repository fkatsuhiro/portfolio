---
import Layout from '../layouts/Layout.astro';
// Sidebarの表示も BlogList 内で行うため、ここでは BlogList だけを読み込みます
import BlogList from '../components/BlogList';
import ogs from 'open-graph-scraper';

// --- 1. ブログ/スライド記事のデータ定義 ---
// ここに新しい記事を追加していきます
const slideSources = [
  {
    id: 'session-storage',
    time: '2025-10-21',
    link: 'https://zenn.dev/kattu/articles/469528b9bd5150',
    sidebarLabel: 'SessionStorage を活用してトースト表示を制御する',
  },
  {
    id: 'pyconjp-2025',
    time: '2025-09-30',
    link: 'https://zenn.dev/kattu/articles/37e76909dc555e',
    sidebarLabel: 'PyCon Jp 2025 参加レポート 【遠方支援制度】',
  },
  {
    id: 'judge-ip-in-cidr',
    time: '2025-09-23',
    link: 'https://zenn.dev/kattu/articles/29be5bfc452e53',
    sidebarLabel: 'CIDRにIPが含まれるかどうかを判定する方法を考える',
  },
  {
    id: 'frontend-conf-tokyo-2025',
    time: '2025-09-21',
    link: 'https://zenn.dev/kattu/articles/e977ff28185cbf',
    sidebarLabel: 'フロントエンドカンファレンス東京 2025 参加レポート',
  },
];

// --- 2. OGP画像の自動取得ロジック ---
// ビルド時に一度だけ実行され、各リンク先のメタデータを取得します
const fetchSlides = async () => {
  const promises = slideSources.map(async (source) => {
    try {
      const targetUrl = source.link;
      
      // スクレイピング実行
      // User-Agentを偽装してブロックを回避します
      const { result } = await ogs({
        url: targetUrl,
        fetchOptions: {
          headers: {
            'user-agent':
              'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
          },
        },
      });

      const ogImage = result.ogImage?.[0]?.url;

      // 取得したデータと元のデータをマージして返します
      return {
        ...source, // id, time, link, sidebarLabel を引き継ぐ
        
        // 自動取得したデータをセット
        image: ogImage || '/images/default-thumbnail.jpg', // 画像がない場合のフォールバック
        title: result.ogTitle || source.sidebarLabel,       // タイトルが取れなければサイドバーラベルで代用
        description: result.ogDescription || '',
      };
    } catch (e) {
      console.error(`Fetch error for ${source.id}:`, e);
      // エラー時も最低限のデータで返す（ビルドを止めないため）
      return {
        ...source,
        image: '/images/default-thumbnail.jpg',
        title: source.sidebarLabel,
        description: 'Failed to fetch description.',
      };
    }
  });

  // 全てのリクエストが完了するのを待ちます
  return await Promise.all(promises);
};

// ここでデータが生成されます
const slides = await fetchSlides();
---

<Layout title="Blogs | My Portfolio">
  <BlogList items={slides} client:load />
</Layout>
