---
import Layout from '../layouts/Layout.astro';
import BlogList from '../components/BlogList';
import ogs from 'open-graph-scraper';

const slideSources = [
  {
    id: 'session-storage',
    time: '2025-10-21',
    link: 'https://zenn.dev/kattu/articles/469528b9bd5150',
    sidebarLabel: 'SessionStorage を活用してトースト表示を制御する',
  },
  {
    id: 'pyconjp-2025',
    time: '2025-09-30',
    link: 'https://zenn.dev/kattu/articles/37e76909dc555e',
    sidebarLabel: 'PyCon Jp 2025 参加レポート 【遠方支援制度】',
  },
  {
    id: 'judge-ip-in-cidr',
    time: '2025-09-23',
    link: 'https://zenn.dev/kattu/articles/29be5bfc452e53',
    sidebarLabel: 'CIDRにIPが含まれるかどうかを判定する方法を考える',
  },
  {
    id: 'frontend-conf-tokyo-2025',
    time: '2025-09-21',
    link: 'https://zenn.dev/kattu/articles/e977ff28185cbf',
    sidebarLabel: 'フロントエンドカンファレンス東京 2025 参加レポート',
  },
];

const fetchSlides = async () => {
  const promises = slideSources.map(async (source) => {
    try {
      const targetUrl = source.link;
      const { result } = await ogs({
        url: targetUrl,
        fetchOptions: {
          headers: {
            'user-agent':
              'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
          },
        },
      });

      const ogImage = result.ogImage?.[0]?.url;
      return {
        ...source,
        image: ogImage || '/images/default-thumbnail.jpg',
        title: result.ogTitle || source.sidebarLabel,
        description: result.ogDescription || '',
      };
    } catch (e) {
      console.error(`Fetch error for ${source.id}:`, e);
      return {
        ...source,
        image: '/images/default-thumbnail.jpg',
        title: source.sidebarLabel,
        description: 'Failed to fetch description.',
      };
    }
  });

  return await Promise.all(promises);
};

const slides = await fetchSlides();
---

<Layout title="Blogs | My Portfolio">
  <BlogList items={slides} client:load />
</Layout>
